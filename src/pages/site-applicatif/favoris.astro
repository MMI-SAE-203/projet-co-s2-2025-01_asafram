---
import LayoutApplicatif from "../../layouts/LayoutApplicatif.astro";
import {
  isUserLoggedIn,
  getUserFavorites,
  removeFromFavorites,
} from "../../../backend/backend.js";
import IconeEtoile from "../../assets/icones/icone-etoile.svg";
import IconeCoeur from "../../assets/icones/icone-etoile.svg"; // À adapter si vous avez une icône de cœur
import IconeVide from "../../assets/icones/icone-localisation.svg"; // À utiliser comme icône pour l'état vide

// Définir des interfaces pour la structure des données
interface ProduitItem {
  id: string;
  nom: string;
  img: string;
  prix?: number;
}

interface RecetteItem {
  id: string;
  nom: string;
  img: string;
  tempsPreparation?: number;
  difficulte?: string;
}

interface BoutiqueItem {
  id: string;
  nom: string;
  img: string;
  adresse?: string;
  distance?: number;
}

interface FavoriProduit {
  id: string;
  item: ProduitItem;
  type: string;
}

interface FavoriRecette {
  id: string;
  item: RecetteItem;
  type: string;
}

interface FavoriBoutique {
  id: string;
  item: BoutiqueItem;
  type: string;
}

interface Favoris {
  produits: FavoriProduit[];
  recettes: FavoriRecette[];
  boutiques: FavoriBoutique[];
}

// Vérifier si l'utilisateur est connecté
const userLoggedIn = isUserLoggedIn();

// Récupérer les favoris de l'utilisateur s'il est connecté
let favorites: Favoris = { produits: [], recettes: [], boutiques: [] };
if (userLoggedIn) {
  try {
    favorites = (await getUserFavorites()) as Favoris;
  } catch (error) {
    console.error("Erreur lors de la récupération des favoris:", error);
  }
}

// Nombre total de favoris
const totalFavoris =
  favorites.produits.length +
  favorites.recettes.length +
  favorites.boutiques.length;
---

<LayoutApplicatif
  title="Mes Favoris | ASAFRAM"
  description="Gérez vos produits, recettes et boutiques favoris sur ASAFRAM"
>
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">Mes Favoris</h1>
      <p class="text-gray-600">
        {totalFavoris} élément{totalFavoris > 1 ? "s" : ""} sauvegardé{
          totalFavoris > 1 ? "s" : ""
        }
      </p>
    </div>

    <!-- Navigation entre les types de favoris -->
    <div class="mb-8" x-data="{ activeTab: 'produits' }">
      <div class="border-b border-gray-200">
        <nav class="flex -mb-px space-x-8">
          <button
            @click="activeTab = 'produits'"
            :class="activeTab === 'produits' ? 'border-saumon text-saumon' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
            class="py-4 px-1 border-b-2 font-medium text-lg transition-colors duration-200"
          >
            Produits ({favorites.produits.length})
          </button>
          <button
            @click="activeTab = 'recettes'"
            :class="activeTab === 'recettes' ? 'border-saumon text-saumon' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
            class="py-4 px-1 border-b-2 font-medium text-lg transition-colors duration-200"
          >
            Recettes ({favorites.recettes.length})
          </button>
          <button
            @click="activeTab = 'boutiques'"
            :class="activeTab === 'boutiques' ? 'border-saumon text-saumon' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
            class="py-4 px-1 border-b-2 font-medium text-lg transition-colors duration-200"
          >
            Boutiques ({favorites.boutiques.length})
          </button>
        </nav>
      </div>

      <!-- Conteneur des produits favoris -->
      <div x-show="activeTab === 'produits'" class="mt-6">
        {
          !userLoggedIn ? (
            <div class="flex flex-col items-center justify-center py-16 bg-gray-50 rounded-lg">
              <img
                src={IconeVide.src}
                alt=""
                class="w-20 h-20 mb-4 opacity-40"
              />
              <h3 class="text-xl font-semibold mb-2">
                Connectez-vous pour voir vos favoris
              </h3>
              <p class="text-gray-500 mb-6 text-center max-w-md">
                Vous devez être connecté pour accéder à votre liste de favoris
                et retrouver vos produits préférés.
              </p>
              <a
                href="/site-applicatif/compte"
                class="px-8 py-3 bg-saumon text-white font-bold rounded-full hover:bg-[#e69c50] transition-colors duration-300"
              >
                Se connecter
              </a>
            </div>
          ) : favorites.produits.length === 0 ? (
            <div class="flex flex-col items-center justify-center py-16 bg-gray-50 rounded-lg">
              <img
                src={IconeEtoile.src}
                alt=""
                class="w-20 h-20 mb-4 opacity-40"
              />
              <h3 class="text-xl font-semibold mb-2">
                Aucun produit en favoris
              </h3>
              <p class="text-gray-500 mb-6 text-center max-w-md">
                Découvrez notre catalogue et ajoutez des produits à vos favoris
                pour les retrouver ici.
              </p>
              <a
                href="/site-applicatif"
                class="px-8 py-3 bg-saumon text-white font-bold rounded-full hover:bg-[#e69c50] transition-colors duration-300"
              >
                Découvrir les produits
              </a>
            </div>
          ) : (
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-6">
              {favorites.produits.map((favItem) => (
                <div class="relative group">
                  <a
                    href={`/site-applicatif/produits/${favItem.item.id}`}
                    class="block h-full"
                  >
                    <div class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-300 border-2 border-transparent hover:border-saumon h-full flex flex-col">
                      <div class="w-full h-48 bg-gray-50 flex items-center justify-center relative">
                        <div class="w-40 h-40 bg-saumon opacity-75 rounded-full absolute" />
                        <img
                          src={favItem.item.img}
                          alt={favItem.item.nom}
                          class="w-36 h-36 object-contain relative z-10"
                        />
                      </div>
                      <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-lg font-bold mb-2 line-clamp-2">
                          {favItem.item.nom}
                        </h3>
                        <div class="text-lg font-bold text-black mt-auto">
                          {favItem.item.prix
                            ? `${favItem.item.prix.toFixed(2)}€`
                            : ""}
                        </div>
                      </div>
                    </div>
                  </a>
                  <button
                    class="remove-favorite-btn absolute top-3 right-3 w-9 h-9 bg-white rounded-full flex justify-center items-center shadow-md transition-transform hover:scale-110 z-20"
                    data-favorite-id={favItem.id}
                    aria-label="Retirer des favoris"
                  >
                    <img
                      src={IconeEtoile.src}
                      alt="Retirer des favoris"
                      width={16}
                      height={16}
                      class="opacity-100"
                    />
                  </button>
                </div>
              ))}
            </div>
          )
        }
      </div>

      <!-- Conteneur des recettes favorites -->
      <div x-show="activeTab === 'recettes'" class="mt-6">
        {
          !userLoggedIn ? (
            <div class="flex flex-col items-center justify-center py-16 bg-gray-50 rounded-lg">
              <img
                src={IconeVide.src}
                alt=""
                class="w-20 h-20 mb-4 opacity-40"
              />
              <h3 class="text-xl font-semibold mb-2">
                Connectez-vous pour voir vos favoris
              </h3>
              <p class="text-gray-500 mb-6 text-center max-w-md">
                Vous devez être connecté pour accéder à votre liste de favoris
                et retrouver vos recettes préférées.
              </p>
              <a
                href="/site-applicatif/compte"
                class="px-8 py-3 bg-saumon text-white font-bold rounded-full hover:bg-[#e69c50] transition-colors duration-300"
              >
                Se connecter
              </a>
            </div>
          ) : favorites.recettes.length === 0 ? (
            <div class="flex flex-col items-center justify-center py-16 bg-gray-50 rounded-lg">
              <img
                src={IconeEtoile.src}
                alt=""
                class="w-20 h-20 mb-4 opacity-40"
              />
              <h3 class="text-xl font-semibold mb-2">
                Aucune recette en favoris
              </h3>
              <p class="text-gray-500 mb-6 text-center max-w-md">
                Découvrez nos recettes et ajoutez-les à vos favoris pour les
                retrouver ici.
              </p>
              <a
                href="/recettes"
                class="px-8 py-3 bg-saumon text-white font-bold rounded-full hover:bg-[#e69c50] transition-colors duration-300"
              >
                Découvrir les recettes
              </a>
            </div>
          ) : (
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-6">
              {favorites.recettes.map((favItem) => (
                <div class="relative group">
                  <a href={`/recettes/${favItem.item.id}`} class="block h-full">
                    <div class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-300 border-2 border-transparent hover:border-saumon h-full flex flex-col">
                      <div class="w-full h-48 relative">
                        <img
                          src={favItem.item.img}
                          alt={favItem.item.nom}
                          class="w-full h-full object-cover"
                        />
                      </div>
                      <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-lg font-bold mb-2 line-clamp-2">
                          {favItem.item.nom}
                        </h3>
                        <div class="mt-2 flex items-center text-sm text-gray-600">
                          <span class="mr-4">
                            {favItem.item.tempsPreparation || 0} min
                          </span>
                          <span>{favItem.item.difficulte || "Facile"}</span>
                        </div>
                      </div>
                    </div>
                  </a>
                  <button
                    class="remove-favorite-btn absolute top-3 right-3 w-9 h-9 bg-white rounded-full flex justify-center items-center shadow-md transition-transform hover:scale-110 z-20"
                    data-favorite-id={favItem.id}
                    aria-label="Retirer des favoris"
                  >
                    <img
                      src={IconeEtoile.src}
                      alt="Retirer des favoris"
                      width={16}
                      height={16}
                      class="opacity-100"
                    />
                  </button>
                </div>
              ))}
            </div>
          )
        }
      </div>

      <!-- Conteneur des boutiques favorites -->
      <div x-show="activeTab === 'boutiques'" class="mt-6">
        {
          !userLoggedIn ? (
            <div class="flex flex-col items-center justify-center py-16 bg-gray-50 rounded-lg">
              <img
                src={IconeVide.src}
                alt=""
                class="w-20 h-20 mb-4 opacity-40"
              />
              <h3 class="text-xl font-semibold mb-2">
                Connectez-vous pour voir vos favoris
              </h3>
              <p class="text-gray-500 mb-6 text-center max-w-md">
                Vous devez être connecté pour accéder à votre liste de favoris
                et retrouver vos boutiques préférées.
              </p>
              <a
                href="/site-applicatif/compte"
                class="px-8 py-3 bg-saumon text-white font-bold rounded-full hover:bg-[#e69c50] transition-colors duration-300"
              >
                Se connecter
              </a>
            </div>
          ) : favorites.boutiques.length === 0 ? (
            <div class="flex flex-col items-center justify-center py-16 bg-gray-50 rounded-lg">
              <img
                src={IconeEtoile.src}
                alt=""
                class="w-20 h-20 mb-4 opacity-40"
              />
              <h3 class="text-xl font-semibold mb-2">
                Aucune boutique en favoris
              </h3>
              <p class="text-gray-500 mb-6 text-center max-w-md">
                Découvrez nos boutiques et ajoutez-les à vos favoris pour les
                retrouver ici.
              </p>
              <a
                href="/magasins"
                class="px-8 py-3 bg-saumon text-white font-bold rounded-full hover:bg-[#e69c50] transition-colors duration-300"
              >
                Découvrir les boutiques
              </a>
            </div>
          ) : (
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 mt-6">
              {favorites.boutiques.map((favItem) => (
                <div class="relative group">
                  <a href={`/magasins/${favItem.item.id}`} class="block h-full">
                    <div class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-300 border-2 border-transparent hover:border-saumon h-full flex flex-col">
                      <div class="w-full h-44 relative">
                        <img
                          src={favItem.item.img}
                          alt={favItem.item.nom}
                          class="w-full h-full object-cover"
                        />
                      </div>
                      <div class="p-4 flex-grow flex flex-col">
                        <h3 class="text-lg font-bold mb-2">
                          {favItem.item.nom}
                        </h3>
                        <p class="text-gray-600 text-sm mb-2 line-clamp-2">
                          {favItem.item.adresse}
                        </p>
                        {favItem.item.distance && (
                          <div class="mt-auto text-sm inline-flex items-center bg-gray-100 px-3 py-1 rounded-full">
                            <span>{favItem.item.distance} km</span>
                          </div>
                        )}
                      </div>
                    </div>
                  </a>
                  <button
                    class="remove-favorite-btn absolute top-3 right-3 w-9 h-9 bg-white rounded-full flex justify-center items-center shadow-md transition-transform hover:scale-110 z-20"
                    data-favorite-id={favItem.id}
                    aria-label="Retirer des favoris"
                  >
                    <img
                      src={IconeEtoile.src}
                      alt="Retirer des favoris"
                      width={16}
                      height={16}
                      class="opacity-100"
                    />
                  </button>
                </div>
              ))}
            </div>
          )
        }
      </div>
    </div>
  </div>
</LayoutApplicatif>

<script>
  import { removeFromFavorites } from "../../../backend/backend.js";

  document.addEventListener("DOMContentLoaded", () => {
    const removeFavButtons = document.querySelectorAll(".remove-favorite-btn");

    removeFavButtons.forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();

        const favoriteId = btn.getAttribute("data-favorite-id");
        if (!favoriteId) return;

        try {
          // Animation de suppression
          const card = btn.closest(".relative") as HTMLElement;
          if (!card) return;

          card.style.transition = "all 0.3s ease";
          card.style.opacity = "0.5";
          card.style.transform = "scale(0.95)";

          // Utiliser directement la fonction du backend pour supprimer le favori
          const success = await removeFromFavorites(favoriteId);

          if (success) {
            // Si la suppression a réussi, on retire l'élément de la page
            setTimeout(() => {
              card.style.height = "0";
              card.style.margin = "0";
              card.style.padding = "0";
              card.style.overflow = "hidden";

              setTimeout(() => {
                card.remove();

                // Mettre à jour les compteurs de favoris
                const tabButtons = document.querySelectorAll("nav button");
                const activeTab = Array.from(tabButtons).find((btn) =>
                  btn.className.includes("border-saumon")
                );

                if (activeTab) {
                  const countText = activeTab.textContent;
                  const match = countText?.match(/\((\d+)\)/);
                  if (match && match[1]) {
                    const currentCount = parseInt(match[1]);
                    const newCount = Math.max(0, currentCount - 1);
                    activeTab.textContent =
                      activeTab.textContent?.replace(
                        /\(\d+\)/,
                        `(${newCount})`
                      ) || "";

                    // Si le nombre est à 0, afficher le message "aucun favori"
                    if (newCount === 0) {
                      const gridContainer = card.parentElement;
                      if (!gridContainer) return;

                      const tabContent = gridContainer.parentElement;
                      if (!tabContent) return;

                      // Créer le message "aucun favori"
                      let emptyMessage;
                      if (activeTab.textContent?.includes("Produits")) {
                        emptyMessage = createEmptyState("produits");
                      } else if (activeTab.textContent?.includes("Recettes")) {
                        emptyMessage = createEmptyState("recettes");
                      } else {
                        emptyMessage = createEmptyState("boutiques");
                      }

                      // Remplacer la grille par le message
                      gridContainer.remove();
                      tabContent.appendChild(emptyMessage);
                    }
                  }
                }

                // Mettre à jour le compteur total
                const totalCounter = document.querySelector("p.text-gray-600");
                if (totalCounter) {
                  const text = totalCounter.textContent;
                  const match = text?.match(/(\d+)/);
                  if (match && match[1]) {
                    const totalCount = parseInt(match[1]);
                    const newTotalCount = Math.max(0, totalCount - 1);
                    totalCounter.textContent = `${newTotalCount} élément${newTotalCount > 1 ? "s" : ""} sauvegardé${newTotalCount > 1 ? "s" : ""}`;
                  }
                }
              }, 300);
            }, 300);
          } else {
            // Si la suppression a échoué, on remet la carte dans son état normal
            card.style.opacity = "1";
            card.style.transform = "scale(1)";
            console.error("Erreur lors de la suppression du favori");
          }
        } catch (error) {
          console.error("Erreur:", error);
          // Remettre la carte dans son état normal en cas d'erreur
          const card = btn.closest(".relative") as HTMLElement;
          if (card) {
            card.style.opacity = "1";
            card.style.transform = "scale(1)";
          }
        }
      });
    });

    // Fonction pour créer l'état vide
    function createEmptyState(type: string): HTMLElement {
      const div = document.createElement("div");
      div.className =
        "flex flex-col items-center justify-center py-16 bg-gray-50 rounded-lg mt-6";

      let destination, message;
      if (type === "produits") {
        destination = "/site-applicatif";
        message =
          "Découvrez notre catalogue et ajoutez des produits à vos favoris pour les retrouver ici.";
      } else if (type === "recettes") {
        destination = "/recettes";
        message =
          "Découvrez nos recettes et ajoutez-les à vos favoris pour les retrouver ici.";
      } else {
        destination = "/magasins";
        message =
          "Découvrez nos boutiques et ajoutez-les à vos favoris pour les retrouver ici.";
      }

      const favIconElement = document.querySelector(
        'img[alt="Retirer des favoris"]'
      );
      const iconSrc = favIconElement
        ? (favIconElement as HTMLImageElement).src
        : "";

      div.innerHTML = `
        <img src="${iconSrc}" alt="" class="w-20 h-20 mb-4 opacity-40" />
        <h3 class="text-xl font-semibold mb-2">Aucun${type === "produits" ? " produit" : type === "recettes" ? "e recette" : "e boutique"} en favoris</h3>
        <p class="text-gray-500 mb-6 text-center max-w-md">${message}</p>
        <a href="${destination}" class="px-8 py-3 bg-saumon text-white font-bold rounded-full hover:bg-[#e69c50] transition-colors duration-300">
          Découvrir les ${type}
        </a>
      `;

      return div;
    }
  });
</script>

<style>
  /* Animation de pulsation pour l'étoile quand on la survole */
  .remove-favorite-btn:hover img {
    animation: pulse 1s infinite;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }

  /* Animation de transition pour les onglets */
  [x-cloak] {
    display: none !important;
  }
</style>
